---
title: "Amazon"
format: html
editor: visual
---

# Load Libraries

```{r}
library(tidymodels)
library(vroom)
library(embed)
library(kknn)
```

# Import Data

```{r}
train <- vroom("~/GitHub/Stat 348/Amazon/Data/train.csv")
test <- vroom("~/GitHub/Stat 348/Amazon/Data/test.csv")
```

# Recipe

```{r}
train <- train %>%
  mutate(ACTION = as.factor(ACTION))

amazon_recipe <- recipe(ACTION ~ ., data = train) %>%
  step_string2factor(all_nominal_predictors()) %>%
  step_other(all_nominal_predictors(), threshold = 0.001) %>%
  step_lencode_mixed(all_nominal_predictors(), outcome = vars(ACTION)) %>%
  step_normalize(all_numeric_predictors()) %>%
  step_pca(all_predictors(), threshold=1)

amazon_prep <- prep(amazon_recipe)
amazon_train <- bake(amazon_prep, new_data = NULL)
amazon_test <- bake(amazon_prep, new_data = test)

```

Models

```{r}
model <- nearest_neighbor(neighbors = tune()) %>% 
  set_mode("classification") %>%
  set_engine("kknn")

```

Workflow

```{r}
wf <- workflow() %>%
  add_recipe(amazon_recipe) %>%
  add_model(model)

```

Tune

```{r}
tune_grid <- grid_regular(neighbors(range = c(50, 250)), levels = 5)


folds <- vfold_cv(train, v = 5)

## Run the CV
CV_results <- wf %>%
  tune_grid(
    resamples = folds,
    grid = tune_grid,
    metrics = metric_set(roc_auc, accuracy)
  )
```

# Best model

```{r}
bestTune <- CV_results %>%
  select_best(metric = "roc_auc")
```

Predictions

```{r}
final_wf <- wf %>%
  finalize_workflow(bestTune) %>%
  fit(data = train)

amazon_predictions <- predict(final_wf,
new_data = test,
type= "prob") 
```

Print

```{r}
kaggle_submission <- amazon_predictions |>
  bind_cols(test) |> 
  select(id, .pred_1) |>
  rename(ACTION = .pred_1) 

## Write out the file
vroom_write(x = kaggle_submission,
            file = "~/GitHub/Stat 348/Amazon/Data/KaggleSub/Kaggle_KNN_PCA.csv",
            delim = ",")
```
